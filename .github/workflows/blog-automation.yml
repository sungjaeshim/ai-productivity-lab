name: Blog Automation

on:
  push:
    branches: [main]
    paths:
      - 'src/content/blog/**'
  pull_request:
    branches: [main]
  schedule:
    # ë§¤ì£¼ ì¼ìš”ì¼ 01:00 UTC (KST 10:00)
    - cron: '0 1 * * 0'

jobs:
  # ìƒˆ í¬ìŠ¤íŒ… ê°ì§€ & ì•Œë¦¼
  new-post-notify:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check for new posts
        id: check
        run: |
          NEW_POSTS=$(git diff --name-only HEAD~1 HEAD -- 'src/content/blog/*.md' | wc -l)
          echo "count=$NEW_POSTS" >> $GITHUB_OUTPUT
          
          if [ "$NEW_POSTS" -gt 0 ]; then
            TITLES=$(git diff --name-only HEAD~1 HEAD -- 'src/content/blog/*.md' | xargs basename -a .md | tr '\n' ', ')
            echo "titles=$TITLES" >> $GITHUB_OUTPUT
          fi
      
      - name: Notify (optional webhook)
        if: steps.check.outputs.count > 0
        run: |
          echo "ğŸ†• New posts: ${{ steps.check.outputs.titles }}"
          # TODO: Telegram webhook integration

  # ëŠì–´ì§„ ë§í¬ ì²´í¬
  link-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check internal links
        run: |
          echo "ğŸ”— Checking internal links..."
          # ë‚´ë¶€ ë§í¬ ì¶”ì¶œ ë° ê²€ì¦
          grep -roh '\](/[^)]*\)' src/content/blog/*.md | sort -u | while read link; do
            path=$(echo "$link" | sed 's/\](\(.*\))/\1/' | sed 's/#.*//')
            if [[ "$path" == /* ]] && [[ ! -f "src/pages$path.astro" ]] && [[ ! -f "src/content/blog${path}.md" ]]; then
              echo "âš ï¸ Broken link: $link"
            fi
          done

  # heroImage exact duplicate ì°¨ë‹¨ (ìœ ì‚¬ í—ˆìš©, ì™„ì „ ë™ì¼ë§Œ ì°¨ë‹¨)
  heroimage-exact-duplicate-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed blog posts
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin "${{ github.base_ref }}" --depth=1
            CHANGED=$(git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- 'src/content/blog/*.md' || true)
          else
            BASE="${{ github.event.before }}"
            if [ -z "$BASE" ] || [ "$BASE" = "0000000000000000000000000000000000000000" ]; then
              CHANGED=$(git ls-files 'src/content/blog/*.md' || true)
            else
              CHANGED=$(git diff --name-only "$BASE" "${{ github.sha }}" -- 'src/content/blog/*.md' || true)
            fi
          fi

          COUNT=$(echo "$CHANGED" | sed '/^$/d' | wc -l)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          {
            echo 'files<<EOF'
            echo "$CHANGED"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Check exact duplicate heroImage values (changed posts only)
        if: steps.changed.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t FILES < <(echo "${{ steps.changed.outputs.files }}" | sed '/^$/d')
          node scripts/check-duplicate-hero-images.mjs "${FILES[@]}"

      - name: Skip duplicate check (no blog changes)
        if: steps.changed.outputs.count == '0'
        run: echo "No blog markdown changes. Skipping exact duplicate heroImage check."

  # PR ìë™ ë¼ë²¨ë§
  auto-label:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Label PR by size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const changes = files.reduce((acc, f) => acc + f.changes, 0);
            let sizeLabel = 'size/S';
            if (changes > 500) sizeLabel = 'size/L';
            else if (changes > 100) sizeLabel = 'size/M';
            
            // ì½˜í…ì¸  íƒ€ì… ë¼ë²¨
            const hasBlog = files.some(f => f.filename.includes('blog/'));
            const hasConfig = files.some(f => f.filename.includes('astro.config') || f.filename === 'package.json');
            
            const labels = [sizeLabel];
            if (hasBlog) labels.push('content');
            if (hasConfig) labels.push('config');
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: labels
            });

  # ì£¼ê°„ í†µê³„ ìƒì„±
  weekly-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate weekly stats
        run: |
          echo "ğŸ“Š Weekly Blog Stats"
          echo "===================="
          echo ""
          echo "ğŸ“ Total posts: $(ls -1 src/content/blog/*.md | wc -l)"
          echo "ğŸ“… Posts this week: $(git log --since='7 days ago' --name-only --pretty=format: -- 'src/content/blog/*.md' | sort -u | wc -l)"
          echo "âœï¸ Commits this week: $(git log --since='7 days ago' --oneline | wc -l)"
          echo ""
          echo "ğŸ“š Recent posts:"
          ls -lt src/content/blog/*.md | head -5 | awk '{print "  â€¢ " $NF}' | xargs -I{} basename {} .md
